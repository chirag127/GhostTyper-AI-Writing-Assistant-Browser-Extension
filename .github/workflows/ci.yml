# .github/workflows/ci.yml
# APEX TECHNICAL AUTHORITY CI PIPELINE (STANDARD 2026)
# Project: GhostTyper-AI-Writing-Assistant-Browser-Extension
# Purpose: Ensures code integrity, quality, and readiness for deployment through automated builds, linting, and testing.

name: 'CI: Build, Lint & Test'

# Ensures that only one workflow run is executed for a given PR or branch.
# Automatically cancels any in-progress runs on the same branch when a new commit is pushed.
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  push:
    branches:
      - 'main'
      - 'develop'
  pull_request:
    branches:
      - 'main'
      - 'develop'
    types: [opened, synchronize, reopened]

jobs:
  build-and-test:
    name: 'Node.js ${{ matrix.node-version }} on ${{ matrix.os }}'
    runs-on: ${{ matrix.os }}

    permissions:
      contents: read # Required for actions/checkout

    strategy:
      matrix:
        os: [ubuntu-latest]
        node-version: [20.x] # Use the current LTS version for stability and performance.

    steps:
      - name: '1. Checkout Repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for all branches and tags.

      - name: '2. Setup Node.js ${{ matrix.node-version }} Environment'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm' # Leverages GitHub's caching for `npm` to speed up subsequent runs.

      - name: '3. Install Project Dependencies'
        run: npm ci # Use `ci` for deterministic builds based on `package-lock.json`.

      - name: '4. Lint & Format Verification (Biome)'
        run: npm run lint:check # Assumes a script like "biome check --apply-unsafe ."

      - name: '5. Build Production Artifacts (Vite/WXT)'
        run: npm run build # Assumes a standard `vite build` or `wxt build` script.

      - name: '6. Execute Unit & Integration Tests (Vitest)'
        run: npm run test:unit # Assumes a script like "vitest run --coverage".

      - name: '7. Upload Code Coverage to Codecov'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          # The Codecov action automatically finds coverage reports.
          # fail_ci_if_error: true # Recommended to enable after initial setup.

      # === OPTIONAL E2E TESTING (Playwright) ===
      # Uncomment the following steps once E2E tests are configured.
      # - name: '8. Install Playwright System Dependencies'
      #   run: npx playwright install --with-deps
      #
      # - name: '9. Execute End-to-End Tests (Playwright)'
      #   run: npm run test:e2e
      #
      # - name: '10. Upload Playwright Report on Failure'
      #   if: failure()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: playwright-report-${{ matrix.os }}
      #     path: playwright-report/
      #     retention-days: 7
